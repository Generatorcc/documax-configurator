<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Documax Configurator</title>
    <style>
        :root { --bg:#0B0B10; --panel:#12121A; --purple:#502D7D; --gold:#FFD35C; --text:#FFFFFF; --muted:#9CA3AF; --border:#2A2A3A; }
        body { margin:0; background:var(--bg); color:var(--text); font-family:system-ui,sans-serif; padding:40px; }
        .panel { background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:24px; margin-bottom:24px; }
        .grid { display:grid; grid-template-columns:2fr 1.2fr 0.8fr 1.2fr 1.2fr 0.5fr; gap:12px; margin-top:16px; align-items:center;}
        input { width:100%; background:#0F0F17; border:1px solid var(--border); border-radius:6px; padding:12px; color:var(--text); font-size:16px; }
        
        /* The Scorecard & Buttons */
        .health-bar { border: 4px solid var(--border); padding: 20px; border-radius: 12px; text-align:center; margin-top:20px; }
        .btn-finalize { background:var(--purple); color:white; padding:15px 30px; border:none; border-radius:8px; font-weight:bold; cursor:pointer; width:100%; font-size:18px; }
        .btn-adj { background:#e74c3c; display:none; }
        .dropdown { position:absolute; background:#161622; border:1px solid var(--border); width:100%; z-index:100; max-height:200px; overflow-y:auto; }
        .dropdown div { padding:10px; cursor:pointer; border-bottom:1px solid var(--border); }
        .dropdown div:hover { background:var(--purple); }
        .status-text { font-size: 24px; font-weight:bold; margin-bottom:5px; }
        .green { color:#2ecc71; border-color:#2ecc71; }
        .yellow { color:#f1c40f; border-color:#f1c40f; }
        .red { color:#e74c3c; border-color:#e74c3c; }
    </style>
</head>
<body>

    <h1>Documax Sales Dashboard</h1>
    <p style="color:var(--muted)">Pricebook items automatically synced with Profit Benchmarks.</p>

    <div class="panel">
        <div class="grid" style="color:var(--muted); font-size:12px; text-transform:uppercase;">
            <div>Product Name</div><div>Item Code</div><div>Qty</div><div>Benchmark Unit</div><div>Line Total</div><div></div>
        </div>
        <div id="rows"></div>
        <button onclick="addRow()" style="margin-top:20px; background:none; border:1px solid var(--purple); color:white; padding:10px; cursor:pointer;">+ Add Item from Pricebook</button>
    </div>

    <div class="panel" id="scorecardPanel">
        <div id="healthDisplay" class="health-bar">
            <div id="statusLabel" class="status-text">Deal Health: Pending</div>
            <div id="profitLabel" style="font-size:14px;">Add items to calculate Operating Profit</div>
        </div>
        <div style="margin-top:20px;">
            <button id="finalizeBtn" class="btn-finalize">Finalize & Send to Proposal</button>
            <button id="adjustBtn" class="btn-finalize btn-adj" onclick="requestAdjustment()">Request Manager Adjustment</button>
        </div>
    </div>

<script>
    const SUPABASE_URL = "https://ucsgkyxzisjtduqdrpnf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjc2dreXh6aXNqdGR1cWRycG5mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxMDIxNDksImV4cCI6MjA4MzY3ODE0OX0.x-pHC2E5ufjguNB5p0cTqR7Qiptv0OE1tFujFuD3Ybo";
    
    // BENCHMARKS (These should match your Analyzer)
    const TARIFF = 0.10;
    const SETUP = 750;
    const SALES_LOAD = 0.34;
    const ADMIN_LOAD = 0.172;
    const TARGET_MARGIN = 0.50;
    const GUARDRAIL_RED = 17.0; // Stringent Sales Floor
    const GUARDRAIL_YELLOW = 20.0;

    function addRow() {
        const row = document.createElement("div");
        row.className = "grid";
        row.style.position = "relative";
        row.innerHTML = `
            <div style="position:relative"><input class="search" placeholder="Search Supabase..."><div class="dropdown" style="display:none"></div></div>
            <div><input class="code" readonly></div>
            <div><input class="qty" type="number" value="1" oninput="calculateDeal()"></div>
            <div><input class="unit" readonly></div>
            <div><input class="total" readonly></div>
            <button onclick="this.parentElement.remove();calculateDeal()" style="background:none; border:none; color:red; cursor:pointer; font-size:20px;">Ã—</button>
            <input type="hidden" class="raw-cost">
        `;
        
        const input = row.querySelector(".search");
        input.addEventListener("input", () => searchSupabase(row, input.value));
        document.getElementById("rows").appendChild(row);
    }

    async function searchSupabase(row, query) {
        if(query.length < 3) return;
        const res = await fetch(`${SUPABASE_URL}/rest/v1/v_product_with_baseline_price?select=*&product_name.ilike.*${query}*`, {
            headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }
        });
        const data = await res.json();
        const dd = row.querySelector(".dropdown");
        dd.innerHTML = "";
        data.forEach(p => {
            const div = document.createElement("div");
            div.innerText = p.product_name;
            div.onclick = () => {
                row.querySelector(".search").value = p.product_name;
                row.querySelector(".code").value = p.product_code;
                row.querySelector(".raw-cost").value = (p.price_cents / 100);
                dd.style.display = "none";
                calculateDeal();
            };
            dd.appendChild(div);
        });
        dd.style.display = "block";
    }

    function calculateDeal() {
        let totalSales = 0;
        let totalBasis = 0;

        document.querySelectorAll("#rows .grid").forEach(row => {
            const raw = parseFloat(row.querySelector(".raw-cost").value) || 0;
            const qty = parseInt(row.querySelector(".qty").value) || 0;
            
            // THE HIDDEN ANALYZER MATH
            const basis = raw + (raw * TARIFF) + SETUP;
            const benchmarkUnit = basis / (1 - TARGET_MARGIN);
            
            row.querySelector(".unit").value = "$" + benchmarkUnit.toFixed(2);
            row.querySelector(".total").value = "$" + (benchmarkUnit * qty).toFixed(2);
            
            totalSales += (benchmarkUnit * qty);
            totalBasis += (basis * qty);
        });

        // CALCULATE OPERATING PROFIT
        const opProfit = totalSales > 0 ? ((totalSales - totalBasis - (totalSales * SALES_LOAD) - (totalSales * ADMIN_LOAD)) / totalSales) * 100 : 0;
        
        updateUI(opProfit);
    }

    function updateUI(profit) {
        const bar = document.getElementById("healthDisplay");
        const label = document.getElementById("statusLabel");
        const finalize = document.getElementById("finalizeBtn");
        const adjust = document.getElementById("adjustBtn");

        document.getElementById("profitLabel").innerText = `Projected Operating Profit: ${profit.toFixed(1)}%`;

        if(profit >= GUARDRAIL_YELLOW) {
            bar.className = "health-bar green";
            label.innerText = "Deal Health: ELITE";
            finalize.style.display = "block"; adjust.style.display = "none";
        } else if (profit >= GUARDRAIL_RED) {
            bar.className = "health-bar yellow";
            label.innerText = "Deal Health: MARGIN WARNING";
            finalize.style.display = "block"; adjust.style.display = "none";
        } else {
            bar.className = "health-bar red";
            label.innerText = "Deal Health: ADJUSTMENT REQUIRED";
            finalize.style.display = "none"; adjust.style.display = "block";
        }
    }

    function requestAdjustment() {
        const reason = prompt("Why does this deal require a margin adjustment? (Competitor name, volume, etc.)");
        if(reason) {
            alert("Adjustment Request Sent to Manager. Opportunity Locked.");
            // Webhook logic to HighLevel would go here
        }
    }

    addRow();
</script>
</body>
</html>
